<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Tabellen</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 1rem; }
    .container { max-width: 95vw; margin: 0 auto; }
    .picker { margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    th { background: #f6f6f6; position: sticky; top: 0; }
    .filter { flex: 1; max-width: 320px; }
    .muted { color: #666; font-size: 0.9rem; }
    .group-parent { background: #eef6ff; font-weight: 600; cursor: pointer; }
    .layer-parent { background: #fff4e6; font-weight: 600; cursor: pointer; }
    .group-toggle { display: inline-inline; margin-right: .25rem; vertical-align: middle; }
    .group-toggle svg { width: 12px; height: 12px; display: inline-block; transition: transform .2s ease; }
    /* Right chevron rotates down when open */
    .group-parent[data-open='false'] .group-toggle svg { transform: rotate(0deg); }
    .group-parent:not([data-open='false']) .group-toggle svg { transform: rotate(90deg); }
    .layer-parent[data-open='false'] .group-toggle svg { transform: rotate(0deg); }
    .layer-parent:not([data-open='false']) .group-toggle svg { transform: rotate(90deg); }
    /* New rows visual marking */
    tr.is-new td { background: #fff7cc; }
    .badge-new { display:inline-block; background:#ffec99; color:#5c4400; border:1px solid #e6c466; border-radius:10px; padding:0 6px; font-size:11px; margin-right:6px; }
    .hidden { display: none; }
    .api-indicator { 
      position: fixed; 
      top: 16px; 
      right: 16px; 
      background: white; 
      border: 2px solid #ddd; 
      border-radius: 8px; 
      padding: 12px 16px; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      font-size: 0.85rem;
      max-width: 280px;
    }
    .api-indicator.connected { border-color: #4caf50; }
    .api-indicator.error { border-color: #f44336; }
    .api-status { 
      display: flex; 
      align-items: center; 
      gap: 8px; 
      font-weight: 600; 
      margin-bottom: 6px;
    }
    .api-status-dot { 
      width: 10px; 
      height: 10px; 
      border-radius: 50%; 
      background: #ddd;
    }
    .api-status-dot.connected { background: #4caf50; }
    .api-status-dot.error { background: #f44336; }
    .api-details { color: #666; font-size: 0.8rem; line-height: 1.4; }
  </style>
</head>
<body>
  <!-- API Status Indicator -->
  <div id="apiIndicator" class="api-indicator">
    <div class="api-status">
      <span class="api-status-dot"></span>
      <span>Ansluter till Boverket...</span>
    </div>
  </div>

  <div class="container">
    <h1>Visa tabell</h1>
    <p class="muted">VÃ¤lj en <strong>.xlsx</strong> (server) eller <strong>.csv/.tsv</strong> (klient). Filtrera globalt eller per kolumn. Gruppering sker pÃ¥ kolumnen "Type" om den finns.</p>
    <div class="picker">
      <input id="fileInput" type="file" accept=".xlsx,.csv,.tsv,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,text/csv,text/tab-separated-values"/>
      <input id="filterInput" class="filter" type="search" placeholder="Filtrera rader..." />
      <label for="groupBy" class="muted">Gruppera efter:</label>
      <select id="groupBy"></select>
      <button id="toggleAllBtn" type="button">Fäll ihop alla</button>
    </div>
    <div id="output"></div>
  </div>

  <!-- Layer modal -->
  <div id="layerModal" style="position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center;">
    <div style="background:#fff; padding:16px; border-radius:8px; width: min(520px, 92vw); box-shadow: 0 10px 30px rgba(0,0,0,.2);">
      <h2 style="margin-top:0;">Dela i skikt</h2>
      <div style="display:flex; gap:12px;">
        <label style="flex:1;">
          Antal skikt
          <input id="layerCount" type="number" min="1" value="2" style="width:100%;" />
        </label>
        <label style="flex:2;">
          Tjocklekar (kommaseparerade)
          <input id="layerThicknesses" type="text" placeholder="t.ex. 10,5" style="width:100%;" />
        </label>
      </div>
      <p class="muted">Lämna tjocklekar tomma för att fördela jämnt.</p>
      <div style="display:flex; gap:8px; justify-content:space-between; margin-top:12px;">
        <button id="layerMapClimate" type="button" style="background:#4caf50; color:white; border:1px solid #45a049;">Mappa klimatresurs till skikt</button>
        <div style="display:flex; gap:8px;">
          <button id="layerCancel" type="button">Avbryt</button>
          <button id="layerApply" type="button">Dela</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Climate Resource Mapping modal -->
  <div id="climateModal" style="position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center;">
    <div style="background:#fff; padding:16px; border-radius:8px; width: min(600px, 92vw); max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,.2);">
      <h2 style="margin-top:0;">Mappa klimatresurs</h2>
      
      <div style="margin-bottom: 16px;">
        <label style="display:block; margin-bottom:8px; font-weight:600;">
          Klimatresurs från Boverket
        </label>
        <select id="climateResourceSelect" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;">
          <option value="">Laddar resurser...</option>
        </select>
      </div>

      <p class="muted">Fyra nya kolumner läggs till: "Klimatresurs" med den valda resursen, "Omräkningsfaktor" med resursens omräkningsfaktor, "Omräkningsfaktor enhet" med enheten och "Avfallsfaktor" med resursens avfallsfaktor.</p>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
        <button id="climateCancel" type="button">Avbryt</button>
        <button id="climateApply" type="button">Mappa</button>
      </div>
    </div>
  </div>

  <!-- Multi-layer Climate Resource Mapping modal -->
  <div id="multiLayerClimateModal" style="position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center;">
    <div style="background:#fff; padding:16px; border-radius:8px; width: min(700px, 92vw); max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,.2);">
      <h2 style="margin-top:0;">Mappa klimatresurser till skikt</h2>
      
      <p class="muted" style="margin-bottom:16px;">Välj klimatresurs för varje skikt individuellt.</p>
      
      <div id="multiLayerClimateContent" style="display:flex; flex-direction:column; gap:12px;">
        <!-- Will be populated dynamically -->
      </div>

      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:16px;">
        <button id="multiLayerClimateCancel" type="button">Avbryt</button>
        <button id="multiLayerClimateNext" type="button">Nästa</button>
      </div>
    </div>
  </div>

  <script src="public/app.js"></script>

  <script>
    const apiIndicator = document.getElementById('apiIndicator');
    const climateResourceSelect = document.getElementById('climateResourceSelect');
    
    // Store climate resources globally so they can be accessed when numbering
    window.climateResources = [];
    
    fetch('https://api.boverket.se/klimatdatabas/v2/get-all-resources/senaste/sv/json')
      .then(res =>{
        return res.json();
      })
      .then(data =>{
        console.log('API Response:', data); // Debug log
        
        // Update API indicator with success status
        if(data && data.Resources && Array.isArray(data.Resources)){
          const version = data.Version || 'Okänd version';
          const publishedDate = data.PublishedDate ? new Date(data.PublishedDate).toLocaleDateString('sv-SE') : 'Okänt datum';
          
          apiIndicator.className = 'api-indicator connected';
          apiIndicator.innerHTML = `
            <div class="api-status">
              <span class="api-status-dot connected"></span>
              <span>Boverket API</span>
            </div>
            <div class="api-details">
              Version: ${version}<br>
              Publicerad: ${publishedDate}
            </div>
          `;
          
          // Store resources and populate dropdown
          window.climateResources = data.Resources;
          climateResourceSelect.innerHTML = '<option value="">Välj en resurs...</option>';
          data.Resources.forEach((resource, index) =>{
            const name = resource.Name || 'Namnlös resurs';
            const option = document.createElement('option');
            option.value = index;
            option.textContent = name;
            climateResourceSelect.appendChild(option);
          });
        } else if(Array.isArray(data)){
          // Fallback: if data is directly an array
          apiIndicator.className = 'api-indicator connected';
          apiIndicator.innerHTML = `
            <div class="api-status">
              <span class="api-status-dot connected"></span>
              <span>Boverket API</span>
            </div>
          `;
          
          window.climateResources = data;
          climateResourceSelect.innerHTML = '<option value="">Välj en resurs...</option>';
          data.forEach((resource, index) =>{
            const name = resource.Name || 'Namnlös resurs';
            const option = document.createElement('option');
            option.value = index;
            option.textContent = name;
            climateResourceSelect.appendChild(option);
          });
        } else {
          apiIndicator.className = 'api-indicator error';
          apiIndicator.innerHTML = `
            <div class="api-status">
              <span class="api-status-dot error"></span>
              <span>API-fel</span>
            </div>
            <div class="api-details">Oväntat format</div>
          `;
          climateResourceSelect.innerHTML = '<option value="">Inga resurser tillgängliga</option>';
        }
      })
      .catch(err =>{
        console.error('API Error:', err);
        
        // Update API indicator with error status
        apiIndicator.className = 'api-indicator error';
        apiIndicator.innerHTML = `
          <div class="api-status">
            <span class="api-status-dot error"></span>
            <span>Anslutning misslyckades</span>
          </div>
          <div class="api-details">${err.message || 'Okänt fel'}</div>
        `;
        climateResourceSelect.innerHTML = '<option value="">Kunde inte ladda resurser</option>';
      });
    
  </script>
</body>
</html>