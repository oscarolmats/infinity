<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>INFINITY</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 1rem; }
    .container { max-width: calc(95vw - 340px); margin: 0 auto; margin-right: 360px; }
    .picker { margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    th { background: #f6f6f6; position: sticky; top: 0; }
    .filter { flex: 1; max-width: 320px; }
    .muted { color: #666; font-size: 0.9rem; }
    .group-parent { background: #eef6ff; font-weight: 600; cursor: pointer; }
    .layer-parent { background: #fff4e6; font-weight: 600; cursor: pointer; }
    .group-toggle { display: inline-inline; margin-right: .25rem; vertical-align: middle; }
    .group-toggle svg { width: 12px; height: 12px; display: inline-block; transition: transform .2s ease; }
    /* Right chevron rotates down when open */
    .group-parent[data-open='false'] .group-toggle svg { transform: rotate(0deg); }
    .group-parent:not([data-open='false']) .group-toggle svg { transform: rotate(90deg); }
    .layer-parent[data-open='false'] .group-toggle svg { transform: rotate(0deg); }
    .layer-parent:not([data-open='false']) .group-toggle svg { transform: rotate(90deg); }
    /* New rows visual marking */
    tr.is-new td { background: #fff7cc; }
    .badge-new { display:inline-block; background:#ffec99; color:#5c4400; border:1px solid #e6c466; border-radius:10px; padding:0 6px; font-size:11px; margin-right:6px; }
    
    /* Climate mapping indicators */
    tr.climate-mapped { 
      background-color: #e8f5e9 !important; 
      border-left: 4px solid #4caf50 !important; 
    }
    tr.climate-mapped-alt { 
      background-color: #fff3e0 !important; 
      border-left: 4px solid #ff9800 !important; 
    }
    tr.climate-mapped-both { 
      background: linear-gradient(90deg, #e8f5e9 50%, #fff3e0 50%) !important; 
      border-left: 4px solid #4caf50 !important; 
      border-right: 4px solid #ff9800 !important; 
    }
    
    /* Parent row indicators */
    tr.group-parent.climate-mapped,
    tr.layer-parent.climate-mapped { 
      background-color: #e8f5e9 !important; 
      border-left: 4px solid #4caf50 !important; 
    }
    tr.group-parent.climate-mapped-alt,
    tr.layer-parent.climate-mapped-alt { 
      background-color: #fff3e0 !important; 
      border-left: 4px solid #ff9800 !important; 
    }
    tr.group-parent.climate-mapped-both,
    tr.layer-parent.climate-mapped-both { 
      background: linear-gradient(90deg, #e8f5e9 50%, #fff3e0 50%) !important; 
      border-left: 4px solid #4caf50 !important; 
      border-right: 4px solid #ff9800 !important; 
    }
    
    .hidden { display: none; }
    /* Editable cells */
    td.editable { 
      cursor: text;
      position: relative;
    }
    td.editable:hover {
      background: #f0f0f0;
    }
    td.editable input {
      width: 100%;
      border: 2px solid #4caf50;
      padding: 6px;
      font-family: inherit;
      font-size: inherit;
      box-sizing: border-box;
    }
    .autocomplete-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #ddd;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .autocomplete-item {
      padding: 8px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }
    .autocomplete-item:hover {
      background: #e3f2fd;
    }
    .status-indicators {
      position: fixed; 
      top: 16px; 
      right: 16px; 
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 1000;
    }
    
    /* Make action buttons display horizontally */
    td:first-child {
      display: flex;
      flex-direction: row;
      gap: 4px;
      flex-wrap: wrap;
      align-items: flex-start;
    }
    
    /* Progress Bar Styles */
    .progress-bar {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: 300px;
      height: 8px;
      background-color: #f0f0f0;
      border-radius: 4px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      z-index: 9999;
      border: 2px solid #4caf50;
    }
    
    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #4caf50, #8bc34a);
      width: 0%;
      transition: width 0.3s ease;
      animation: progress-pulse 2s ease-in-out infinite;
    }
    
    .progress-bar-text {
      position: absolute;
      top: -25px;
      left: 0;
      right: 0;
      text-align: center;
      font-size: 12px;
      color: #666;
      font-weight: 500;
    }
    
    @keyframes progress-pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    .api-indicator { 
      background: white; 
      border: 2px solid #ddd; 
      border-radius: 8px; 
      padding: 12px 16px; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      font-size: 0.85rem;
      max-width: 300px;
      width: 300px;
    }
    .api-indicator.connected { border-color: #4caf50; }
    .api-indicator.error { border-color: #f44336; }
    .api-status { 
      display: flex; 
      align-items: center; 
      gap: 8px; 
      font-weight: 600; 
      margin-bottom: 6px;
    }
    .api-status-dot { 
      width: 10px; 
      height: 10px; 
      border-radius: 50%; 
      background: #ddd;
    }
    .api-status-dot.connected { background: #4caf50; }
    .api-status-dot.error { background: #f44336; }
    .api-details { color: #666; font-size: 0.8rem; line-height: 1.4; }
    .climate-summary {
      position: fixed;
      top: 140px;
      right: 16px;
      background: white;
      border: 2px solid #2196f3;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      font-size: 0.9rem;
      width: 300px;
    }
    .climate-summary h3 {
      margin: 0 0 12px 0;
      font-size: 1rem;
      color: #1976d2;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .climate-summary-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #eee;
      align-items: baseline;
    }
    .climate-summary-item:last-child {
      border-bottom: none;
      font-weight: 600;
      font-size: 1.05em;
      padding-top: 12px;
      margin-top: 4px;
      border-top: 2px solid #2196f3;
    }
    .climate-summary-label {
      color: #555;
    }
    .climate-summary-value {
      font-weight: 600;
      color: #1976d2;
      font-family: 'Courier New', monospace;
    }
    .climate-summary-total {
      color: #1565c0 !important;
      font-size: 1.1em;
    }
    
    /* Responsive design for smaller screens */
    @media (max-width: 1200px) {
      .container {
        max-width: 95vw;
        margin-right: auto;
      }
      .api-indicator,
      .climate-summary {
        position: relative;
        right: auto;
        margin-bottom: 16px;
        width: 100%;
        max-width: 400px;
      }
      .climate-summary {
        top: auto;
      }
    }
  </style>
</head>
<body>
  <!-- API Status Indicators -->
  <div class="status-indicators">
    <div id="apiIndicator" class="api-indicator">
      <div class="api-status">
        <span class="api-status-dot"></span>
        <span>Ansluter till Boverket...</span>
      </div>
    </div>
    
    <div id="epdIndicator" class="api-indicator">
      <div class="api-status">
        <span class="api-status-dot"></span>
        <span>Laddar EPD-filer...</span>
      </div>
    </div>
  </div>

  <!-- Climate Impact Summary -->
  <div id="climateSummary" class="climate-summary" style="display: none;">
    <h3>
      <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: currentColor;">
        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
      </svg>
      Klimatpåverkan
    </h3>
    <div class="climate-summary-item">
      <span class="climate-summary-label">A1-A3 (produkt):</span>
      <span class="climate-summary-value" id="summaryA1A3">0.00 kg CO₂e</span>
    </div>
    <div class="climate-summary-item">
      <span class="climate-summary-label">A4 (transport):</span>
      <span class="climate-summary-value" id="summaryA4">0.00 kg CO₂e</span>
    </div>
    <div class="climate-summary-item">
      <span class="climate-summary-label">A5 (byggproduktion):</span>
      <span class="climate-summary-value" id="summaryA5">0.00 kg CO₂e</span>
    </div>
    <div class="climate-summary-item">
      <span class="climate-summary-label">Totalt:</span>
      <span class="climate-summary-value climate-summary-total" id="summaryTotal">0.00 kg CO₂e</span>
    </div>
  </div>

  <!-- Progress Bar -->
  <div id="progressBar" class="progress-bar" style="display: none;">
    <div class="progress-bar-fill"></div>
    <div class="progress-bar-text">Bearbetar...</div>
  </div>

  <div class="container">
    <h1>INFINITY</h1>
    <div class="picker">
      <input id="fileInput" type="file" accept=".xlsx,.csv,.tsv,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,text/csv,text/tab-separated-values"/>
      <input id="filterInput" class="filter" type="search" placeholder="Filtrera rader..." />
      <label for="groupBy" class="muted">Gruppera efter:</label>
      <select id="groupBy"></select>
      <button id="toggleAllBtn" type="button">Fäll ihop alla</button>
      <button id="addRowBtn" type="button" style="background:#607d8b; color:white;">Lägg till rad</button>
      <button id="exportBtn" type="button" style="background:#607d8b; color:white;">Exportera till Excel</button>
      <button id="undoBtn" type="button" style="background:#607d8b; color:white;" title="Ångra (Ctrl+Z)" disabled>↶ Ångra</button>
      <button id="redoBtn" type="button" style="background:#607d8b; color:white;" title="Gör om (Ctrl+Y)" disabled>↷ Gör om</button>
      <button id="saveProjectBtn" type="button" style="background:#607d8b; color:white;">Spara</button>
      <button id="saveAsProjectBtn" type="button" style="background:#607d8b; color:white;">Spara som...</button>
      <button id="loadProjectBtn" type="button" style="background:#607d8b; color:white;">Öppna projekt</button>
      <button id="testProgressBtn" type="button" style="background:#ff9800; color:white;">Testa Progress Bar</button>
      <input id="projectFileInput" type="file" accept=".json,application/json" style="display:none;" />
    </div>
    <div id="output"></div>
  </div>

  <!-- Layer modal -->
  <div id="layerModal" style="position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center;">
    <div style="background:#fff; padding:16px; border-radius:8px; width: min(600px, 92vw); box-shadow: 0 10px 30px rgba(0,0,0,.2); max-height: 90vh; overflow-y: auto;">
      <h2 style="margin-top:0;">Dela i skikt</h2>
      <div style="display:flex; gap:12px;">
        <label style="flex:1;">
          Antal skikt
          <input id="layerCount" type="number" min="1" value="2" style="width:100%;" />
        </label>
        <label style="flex:2;">
          Tjocklekar (kommaseparerade)
          <input id="layerThicknesses" type="text" placeholder="t.ex. 10,5" style="width:100%;" />
        </label>
      </div>
      <p class="muted">Lämna tjocklekar tomma för att fördela jämnt.</p>
      
      <!-- Mixed Layer Section -->
      <div style="margin-top:16px; padding:12px; border:1px solid #ddd; border-radius:4px; background:#f9f9f9;">
        <h3 style="margin-top:0; margin-bottom:12px; font-size:1rem;">Blandade skikt</h3>
        <p class="muted" style="margin-top:0; margin-bottom:12px;">Bocka i vilka skikt som är blandningar av två material:</p>
        
        <div id="mixedLayerCheckboxes" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:8px; margin-bottom:16px;">
          <!-- Will be populated dynamically based on layer count -->
        </div>
        
        <div id="mixedLayerDetails" style="display:none; margin-top:12px; padding-top:12px; border-top:1px solid #ddd;">
          <p class="muted" style="margin-top:0; margin-bottom:12px;">Konfigurera de blandade skikten:</p>
          <div id="mixedLayerConfigs">
            <!-- Will be populated dynamically for each mixed layer -->
          </div>
        </div>
      </div>
      
      <!-- Layer Names and Climate Resources Section -->
      <div id="layerNamesSection" style="margin-top:16px; padding:12px; border:1px solid #ddd; border-radius:4px; background:#f9f9f9;">
        <h3 style="margin-top:0; margin-bottom:12px; font-size:1rem;">Skiktnamn och klimatresurser</h3>
        <p class="muted" style="margin-top:0; margin-bottom:12px;">Namnge varje skikt och välj klimatresurs (valfritt):</p>
        
        <div id="layerNamesContainer">
          <!-- Will be populated dynamically based on layer count -->
        </div>
        
      </div>
      
      <div style="display:flex; gap:8px; justify-content:space-between; margin-top:12px;">
        <div style="display:flex; gap:8px;">
          <button id="layerCancel" type="button">Avbryt</button>
          <button id="layerApply" type="button">Dela</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Climate Resource Mapping modal -->
  <div id="climateModal" style="position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center;">
    <div style="background:#fff; padding:16px; border-radius:8px; width: min(600px, 92vw); max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,.2);">
      <h2 style="margin-top:0;">Mappa klimatresurs</h2>
      
      <div style="margin-bottom: 16px;">
        <label style="display:block; margin-bottom:8px; font-weight:600;">
          Klimatresurs från Boverket
        </label>
        <select id="climateResourceSelect" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;">
          <option value="">Laddar resurser...</option>
        </select>
      </div>

      <p class="muted">Fyra nya kolumner läggs till: "Klimatresurs" med den valda resursen, "Omräkningsfaktor" med resursens omräkningsfaktor, "Omräkningsfaktor enhet" med enheten och "Avfallsfaktor" med resursens avfallsfaktor.</p>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
        <button id="climateCancel" type="button">Avbryt</button>
        <button id="climateApply" type="button">Mappa</button>
      </div>
    </div>
  </div>

  <!-- Alternative Climate Resource modal -->
  <div id="altClimateModal" style="position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:100;">
    <div style="background:#fff; padding:20px; border-radius:8px; width: min(700px, 95vw); max-height: 85vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,.2);">
      <h2 style="margin-top:0; color:#2196f3;">Alternativ klimatresurs</h2>
      
      <!-- EPD Selection Method -->
      <div style="margin-bottom:20px; padding:16px; background:#f8f9fa; border-radius:8px; border:1px solid #e9ecef;">
        <h3 style="margin-top:0; margin-bottom:12px; color:#333; font-size:16px;">Välj datakälla</h3>
        <div style="display:flex; gap:12px; margin-bottom:16px;">
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
            <input type="radio" name="epdSource" value="manual" checked style="margin:0;">
            <span>Manuell inmatning</span>
          </label>
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
            <input type="radio" name="epdSource" value="epd" style="margin:0;">
            <span>Välj från EPD-fil</span>
          </label>
        </div>
        
        <!-- EPD File Selection -->
        <div id="epdFileSection" style="display:none;">
          <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">
            Välj EPD-fil
          </label>
          <select id="epdFileSelect" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:4px; font-size:14px;">
            <option value="">Laddar EPD-filer...</option>
          </select>
          <small style="color:#666; font-size:12px; margin-top:4px; display:block;">
            EPD-filer läses från mappen "epd" i programmets rotmapp
          </small>
        </div>
        
        <!-- EPD Preview -->
        <div id="epdPreview" style="display:none; margin-top:16px; padding:12px; background:#e8f5e8; border-radius:6px; border:1px solid #c3e6c3;">
          <h4 style="margin:0 0 8px 0; color:#2e7d32; font-size:14px;">📋 EPD-förhandsvisning</h4>
          <div id="epdPreviewContent" style="font-size:13px; color:#333;">
            <!-- Will be populated with EPD data -->
          </div>
        </div>
      </div>
      
      <p class="muted" style="margin-bottom:16px;">Mata in EPD-data manuellt för denna resurs.</p>
      
      <div style="display:grid; gap:16px; margin-bottom:20px;">
        <!-- EPD Name -->
        <div>
          <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">
            EPD-namn *
          </label>
          <input id="altClimateName" type="text" placeholder="t.ex. Betong C25/30" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:4px; font-size:14px;" />
        </div>

        <!-- Declared Unit -->
        <div>
          <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">
            Deklarerad enhet *
          </label>
          <select id="altClimateUnit" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:4px; font-size:14px;">
            <option value="">Välj enhet...</option>
            <option value="kg">kg (kilogram)</option>
            <option value="m2">m² (kvadratmeter)</option>
            <option value="m3">m³ (kubikmeter)</option>
            <option value="st">st (styck)</option>
            <option value="m">m (meter)</option>
            <option value="l">l (liter)</option>
            <option value="t">t (ton)</option>
          </select>
        </div>

        <!-- Conversion Factor -->
        <div>
          <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">
            Omräkningsfaktor *
          </label>
          <input id="altClimateFactor" type="number" step="0.001" placeholder="t.ex. 1.0" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:4px; font-size:14px;" />
        </div>

        <!-- Conversion Factor Unit -->
        <div>
          <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">
            Omräkningsfaktor enhet *
          </label>
          <select id="altClimateFactorUnit" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:4px; font-size:14px;">
            <option value="">Välj enhet...</option>
            <option value="kg/m³">kg/m³ (volym)</option>
            <option value="kg/m²">kg/m² (area)</option>
            <option value="kg/m">kg/m (längd)</option>
            <option value="kg/st">kg/st (styck)</option>
          </select>
        </div>

        <!-- Waste Factor -->
        <div>
          <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">
            Spillfaktor (decimaltal)
          </label>
          <input id="altClimateWaste" type="number" step="0.01" placeholder="t.ex. 0.05" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:4px; font-size:14px;" />
          <small style="color:#666; font-size:12px; margin-top:4px; display:block;">
            Används för att beräkna inköpt vikt. 0.05 = 5% spill
          </small>
        </div>

        <!-- Climate Impact A1-A3 -->
        <div>
          <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">
            Klimatpåverkan A1-A3 (kg CO₂e/deklarerad enhet) *
          </label>
          <input id="altClimateA1A3" type="number" step="0.001" placeholder="t.ex. 0.245" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:4px; font-size:14px;" />
        </div>

        <!-- Climate Impact A4 -->
        <div>
          <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">
            Klimatpåverkan A4 (kg CO₂e/deklarerad enhet)
          </label>
          <input id="altClimateA4" type="number" step="0.001" placeholder="t.ex. 0.012" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:4px; font-size:14px;" />
        </div>

        <!-- Climate Impact A5 -->
        <div>
          <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">
            Klimatpåverkan A5 (kg CO₂e/deklarerad enhet)
          </label>
          <input id="altClimateA5" type="number" step="0.001" placeholder="t.ex. 0.008" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:4px; font-size:14px;" />
        </div>
      </div>

      <div style="display:flex; gap:12px; justify-content:flex-end; margin-top:20px; padding-top:16px; border-top:2px solid #ddd;">
        <button id="altClimateCancel" type="button" style="padding:10px 20px; background:#f5f5f5; border:1px solid #ddd; border-radius:4px;">Avbryt</button>
        <button id="altClimateApply" type="button" style="background:#2196f3; color:white; border:1px solid #1976d2; padding:10px 24px; font-weight:600; border-radius:4px;">Lägg till resurs</button>
      </div>
    </div>
  </div>

  <!-- Multi-layer Climate Resource Mapping modal -->
  <div id="multiLayerClimateModal" style="position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:100;">
    <div style="background:#fff; padding:20px; border-radius:8px; width: min(900px, 95vw); max-height: 85vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,.2);">
      <h2 style="margin-top:0;">Mappa klimatresurser till skikt</h2>
      
      <p class="muted" style="margin-bottom:16px;">Sök och välj klimatresurs för varje skikt. Du kan skriva för att filtrera listan.</p>
      
      <div id="multiLayerClimateContent" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap:16px; margin-bottom:16px;">
        <!-- Will be populated dynamically -->
      </div>

      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:16px; padding-top:16px; border-top:2px solid #ddd;">
        <button id="multiLayerClimateCancel" type="button" style="padding:10px 20px;">Avbryt</button>
        <button id="multiLayerClimateApply" type="button" style="background:#4caf50; color:white; border:1px solid #45a049; padding:10px 24px; font-weight:600;">Applicera alla</button>
      </div>
    </div>
  </div>

  <!-- Manual Conversion Factor modal -->
  <div id="manualFactorModal" style="position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index: 1000;">
    <div style="background:#fff; padding:20px; border-radius:8px; width: min(500px, 92vw); box-shadow: 0 10px 30px rgba(0,0,0,.2);">
      <h2 style="margin-top:0; color: #ff9800;">⚠️ Saknad omräkningsfaktor</h2>
      
      <p style="margin-bottom:16px;">
        Den valda klimatresursen <strong id="manualFactorResourceName"></strong> saknar omräkningsfaktor i API:n.
        Vänligen ange en egen omräkningsfaktor:
      </p>

      <div style="display:flex; flex-direction:column; gap:12px; margin-bottom:16px;">
        <label style="display:flex; flex-direction:column; gap:4px;">
          <span style="font-weight:600;">Omräkningsfaktor:</span>
          <input id="manualFactorValue" type="number" step="0.001" placeholder="t.ex. 2400" style="padding:8px; border:1px solid #ddd; border-radius:4px;" />
        </label>

        <label style="display:flex; flex-direction:column; gap:4px;">
          <span style="font-weight:600;">Enhet:</span>
          <select id="manualFactorUnit" style="padding:8px; border:1px solid #ddd; border-radius:4px;">
            <option value="kg/m³">kg/m³ (volym)</option>
            <option value="kg/m²">kg/m² (area)</option>
            <option value="kg/m">kg/m (längd)</option>
            <option value="kg/st">kg/st (styck)</option>
          </select>
        </label>
      </div>

      <div style="display:flex; gap:8px; justify-content:flex-end;">
        <button id="manualFactorCancel" type="button">Avbryt</button>
        <button id="manualFactorApply" type="button" style="background:#4caf50; color:white; border:1px solid #45a049;">Använd</button>
      </div>
    </div>
  </div>

  <!-- SheetJS library for Excel export -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  
  <!-- EPD Parser -->
  <script src="epd-parser.js"></script>
  
  <script src="app.js"></script>

  <script>
    const apiIndicator = document.getElementById('apiIndicator');
    const epdIndicator = document.getElementById('epdIndicator');
    const climateResourceSelect = document.getElementById('climateResourceSelect');
    
    // Store climate resources globally so they can be accessed when numbering
    window.climateResources = [];
    
    fetch('https://api.boverket.se/klimatdatabas/v2/get-all-resources/senaste/sv/json')
      .then(res =>{
        return res.json();
      })
      .then(data =>{
        console.log('API Response:', data); // Debug log
        
        // Update API indicator with success status
        if(data && data.Resources && Array.isArray(data.Resources)){
          const version = data.Version || 'Okänd version';
          const publishedDate = data.PublishedDate ? new Date(data.PublishedDate).toLocaleDateString('sv-SE') : 'Okänt datum';
          
          apiIndicator.className = 'api-indicator connected';
          apiIndicator.innerHTML = `
            <div class="api-status">
              <span class="api-status-dot connected"></span>
              <span>Boverket API</span>
            </div>
            <div class="api-details">
              Version: ${version}<br>
              Publicerad: ${publishedDate}
            </div>
          `;
          
          // Store resources and populate dropdown
          window.climateResources = data.Resources;
          climateResourceSelect.innerHTML = '<option value="">Välj en resurs...</option>';
          data.Resources.forEach((resource, index) =>{
            const name = resource.Name || 'Namnlös resurs';
            const option = document.createElement('option');
            option.value = index;
            option.textContent = name;
            climateResourceSelect.appendChild(option);
          });
        } else if(Array.isArray(data)){
          // Fallback: if data is directly an array
          apiIndicator.className = 'api-indicator connected';
          apiIndicator.innerHTML = `
            <div class="api-status">
              <span class="api-status-dot connected"></span>
              <span>Boverket API</span>
            </div>
          `;
          
          window.climateResources = data;
          climateResourceSelect.innerHTML = '<option value="">Välj en resurs...</option>';
          data.forEach((resource, index) =>{
            const name = resource.Name || 'Namnlös resurs';
            const option = document.createElement('option');
            option.value = index;
            option.textContent = name;
            climateResourceSelect.appendChild(option);
          });
        } else {
          apiIndicator.className = 'api-indicator error';
          apiIndicator.innerHTML = `
            <div class="api-status">
              <span class="api-status-dot error"></span>
              <span>API-fel</span>
            </div>
            <div class="api-details">Oväntat format</div>
          `;
          climateResourceSelect.innerHTML = '<option value="">Inga resurser tillgängliga</option>';
        }
      })
      .catch(err =>{
        console.error('API Error:', err);
        
        // Update API indicator with error status
        apiIndicator.className = 'api-indicator error';
        apiIndicator.innerHTML = `
          <div class="api-status">
            <span class="api-status-dot error"></span>
            <span>Anslutning misslyckades</span>
          </div>
          <div class="api-details">${err.message || 'Okänt fel'}</div>
        `;
        climateResourceSelect.innerHTML = '<option value="">Kunde inte ladda resurser</option>';
      });
    
    // EPD files will be loaded by app.js after it initializes
    
  </script>
</body>
</html>