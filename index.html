<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>INFINITY</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Roboto', system-ui, -apple-system, 'Segoe UI', sans-serif; margin: 1rem; background: #f7f9fc; color: #111827; }
    button, input, select, textarea { font-family: inherit; }
    .container { max-width: calc(95vw - 340px); margin: 0 auto; margin-right: 360px; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.06); padding: 16px; }
    .picker { margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center; }
    /* Toolbar controls styled like modern rounded buttons */
    .picker button {
      border-radius: 9999px;
      padding: 8px 14px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 1px 2px rgba(0,0,0,0.06);
      transition: background-color .15s ease, box-shadow .15s ease, transform .05s ease;
    }
    .picker button:hover {
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      transform: translateY(-1px);
    }
    .picker button:active {
      transform: translateY(0);
      box-shadow: 0 1px 2px rgba(0,0,0,0.06);
    }
    .picker select,
    .picker input[type="search"] {
      border-radius: 9999px;
      padding: 8px 12px;
      border: 1px solid #e5e7eb;
    }
    table { border-collapse: separate; border-spacing: 0; width: 100%; table-layout: fixed; }
    th, td { border-right: 1px solid #e5e7eb; border-bottom: 1px solid #e5e7eb; padding: 6px 8px; font-size: 0.85rem; }
    th { position: sticky; top: 0; background: #ffffff; z-index: 2; text-align: left; font-weight: 600; color: #374151; }
    thead tr { box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    thead th { border-top: 1px solid #e5e7eb; }
    thead th:first-child { border-top-left-radius: 12px; }
    thead th:last-child { border-top-right-radius: 12px; }
    thead th:hover { background: #f8fafc; }
    thead th:first-child, tbody td:first-child { position: sticky; left: 0; background: #fff; z-index: 3; width: 1%; white-space: nowrap; }
    thead th:first-child { z-index: 4; }
    /* Zebra rows via classes for correct alternation with hidden rows */
    tbody tr.zebra-even td { background: #f8fafc; }
    tbody tr.zebra-odd td { background: #eef2f7; }
    /* Allow text to wrap to reduce horizontal width */
    td, th { white-space: normal; word-break: break-word; }
    /* Keep action cell content tight */
    td:first-child > * { gap: 2px; }
    table tbody tr:hover td { background: #e8eef7; }
    table { box-shadow: 0 0 0 1px #e5e7eb; border-radius: 6px; overflow: hidden; }
    .ag-resize-handle { position: absolute; right: 0; top: 0; width: 6px; height: 100%; cursor: col-resize; user-select: none; }
    th { position: sticky; top: 0; }
    thead th.ag-sort-asc::after { content: '▲'; font-size: 10px; margin-left: 6px; color: #6b7280; }
    thead th.ag-sort-desc::after { content: '▼'; font-size: 10px; margin-left: 6px; color: #6b7280; }
    .filter { flex: 1; max-width: 320px; }
    .muted { color: #666; font-size: 0.9rem; }
    .group-parent {
      background: #e3f2fd;
      font-weight: 700;
      cursor: pointer;
      border-left: 5px solid #2196f3 !important;
      box-shadow: inset 0 0 0 1px rgba(33, 150, 243, 0.1);
    }
    .layer-parent {
      background: #e8eaf6;
      font-weight: 700;
      cursor: pointer;
      border-left: 5px solid #3f51b5 !important;
      box-shadow: inset 0 0 0 1px rgba(63, 81, 181, 0.12);
    }
    .group-toggle { display: inline-inline; margin-right: .25rem; vertical-align: middle; }
    .group-toggle svg { width: 12px; height: 12px; display: inline-block; transition: transform .2s ease; }
    /* Right chevron rotates down when open */
    .group-parent[data-open='false'] .group-toggle svg { transform: rotate(0deg); }
    .group-parent:not([data-open='false']) .group-toggle svg { transform: rotate(90deg); }
    .layer-parent[data-open='false'] .group-toggle svg { transform: rotate(0deg); }
    .layer-parent:not([data-open='false']) .group-toggle svg { transform: rotate(90deg); }
    /* New rows visual marking */
    tr.is-new td { background: #fff7cc; }
    .badge-new { display:inline-block; background:#ffec99; color:#5c4400; border:1px solid #e6c466; border-radius:10px; padding:0 6px; font-size:11px; margin-right:6px; }
    
    /* Climate mapping indicators - stronger */
    tr.climate-mapped td { background-color: #dff7e4 !important; }
    tr.climate-mapped { border-left: 5px solid #2e7d32 !important; }
    tr.climate-mapped-alt td { background-color: #ffefdb !important; }
    tr.climate-mapped-alt { border-left: 5px solid #e67e22 !important; }
    tr.climate-mapped-both td { background: linear-gradient(90deg, #dff7e4 50%, #ffefdb 50%) !important; }
    tr.climate-mapped-both { border-left: 5px solid #2e7d32 !important; border-right: 5px solid #e67e22 !important; }
    
    /* Parent row indicators */
    tr.group-parent.climate-mapped,
    tr.layer-parent.climate-mapped { background-color: #dff7e4 !important; border-left: 5px solid #2e7d32 !important; }
    tr.group-parent.climate-mapped-alt,
    tr.layer-parent.climate-mapped-alt { background-color: #ffefdb !important; border-left: 5px solid #e67e22 !important; }
    tr.group-parent.climate-mapped-both,
    tr.layer-parent.climate-mapped-both { background: linear-gradient(90deg, #dff7e4 50%, #ffefdb 50%) !important; border-left: 5px solid #2e7d32 !important; border-right: 5px solid #e67e22 !important; }

    /* Layered parent emphasis only (children keep zebra coloring) */
    tbody tr[data-layer-key] td { background-color: #eef1fb; }

    /* Icon buttons */
    .icon-btn {
      background: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 6px 8px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin: 0 2px;
      transition: all 0.2s ease;
      vertical-align: middle;
    }
    .icon-btn:hover {
      background: #f5f5f5;
      border-color: #999;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .icon-btn svg {
      width: 16px;
      height: 16px;
      display: block;
    }
    .icon-btn.layer-btn { border-color: #2196f3; color: #2196f3; }
    .icon-btn.layer-btn:hover { background: #e3f2fd; border-color: #2196f3; }
    .icon-btn.climate-btn { border-color: #4caf50; color: #4caf50; }
    .icon-btn.climate-btn:hover { background: #e8f5e9; border-color: #4caf50; }
    .icon-btn.epd-btn { border-color: #ff9800; color: #ff9800; }
    .icon-btn.epd-btn:hover { background: #fff3e0; border-color: #ff9800; }

    .hidden { display: none; }
    /* Editable cells */
    td.editable { 
      cursor: text;
      position: relative;
    }
    td.editable:hover {
      background: #f0f0f0;
    }
    td.editable input {
      width: 100%;
      border: 2px solid #4caf50;
      padding: 6px;
      font-family: inherit;
      font-size: inherit;
      box-sizing: border-box;
    }
    .autocomplete-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #ddd;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .autocomplete-item {
      padding: 8px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }
    .autocomplete-item:hover {
      background: #e3f2fd;
    }
    .status-indicators {
      position: fixed;
      bottom: 16px;
      right: 16px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      z-index: 1000;
    }

    /* Make action buttons display horizontally */
    td:first-child {
      white-space: nowrap;
      padding: 4px !important;
      text-align: center;
    }

    td:first-child > * {
      display: inline-flex;
      margin: 0 2px;
      vertical-align: middle;
    }
    
    /* Progress Bar Styles */
    .progress-bar {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: 300px;
      height: 8px;
      background-color: #f0f0f0;
      border-radius: 4px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      z-index: 9999;
      border: 2px solid #4caf50;
    }
    
    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #4caf50, #8bc34a);
      width: 0%;
      transition: width 0.3s ease;
      animation: progress-pulse 2s ease-in-out infinite;
    }
    
    .progress-bar-text {
      position: absolute;
      top: -25px;
      left: 0;
      right: 0;
      text-align: center;
      font-size: 12px;
      color: #666;
      font-weight: 500;
    }
    
    @keyframes progress-pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    .api-indicator {
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 6px 10px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      font-size: 0.75rem;
      max-width: 180px;
    }
    .api-indicator.connected { border-color: #4caf50; }
    .api-indicator.error { border-color: #f44336; }
    .api-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 600;
    }
    .api-status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #ddd;
    }
    .api-status-dot.connected { background: #4caf50; }
    .api-status-dot.error { background: #f44336; }
    .api-details {
      color: #666;
      font-size: 0.7rem;
      line-height: 1.3;
      margin-top: 2px;
    }
    .climate-summary {
      position: fixed;
      top: 16px;
      left: 50%;
      transform: translateX(-50%);
      background: #ffffff;
      border: 1px solid #e5e7eb;
      padding: 10px 16px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.08);
      font-size: 0.85rem;
      z-index: 999;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 24px;
      border-radius: 9999px;
    }
    .climate-summary h3 {
      margin: 0;
      font-size: 0.9rem;
      color: #1976d2;
      font-weight: 700;
      white-space: nowrap;
    }
    .climate-summary-items {
      display: flex;
      gap: 24px;
      align-items: center;
    }
    .climate-summary-item {
      display: flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
    }
    .climate-summary-item:last-child {
      padding-left: 24px;
      margin-left: 8px;
      border-left: 2px solid #2196f3;
    }
    .climate-summary-label {
      color: #555;
      font-size: 0.85rem;
    }
    .climate-summary-value {
      font-weight: 700;
      color: #1976d2;
      font-size: 0.9rem;
    }
    .climate-summary-total {
      color: #1565c0 !important;
      font-size: 1rem;
    }

    /* Add padding to body to account for fixed summary */
    body { padding-top: 100px; }
    
    /* Responsive design for smaller screens */
    @media (max-width: 1200px) {
      .container {
        max-width: 95vw;
        margin-right: auto;
      }
      .api-indicator,
      .climate-summary {
        position: relative;
        right: auto;
        margin-bottom: 16px;
        width: 100%;
        max-width: 400px;
      }
      .climate-summary {
        top: auto;
      }
    }
  </style>
</head>
<body>
  <!-- API Status Indicators -->
  <div class="status-indicators">
    <div id="apiIndicator" class="api-indicator">
      <div class="api-status">
        <span class="api-status-dot"></span>
        <span>Ansluter till Boverket...</span>
      </div>
    </div>
    
    <div id="epdIndicator" class="api-indicator">
      <div class="api-status">
        <span class="api-status-dot"></span>
        <span>Laddar EPD-filer...</span>
      </div>
    </div>
  </div>

  <!-- Climate Impact Summary -->
  <div id="climateSummary" class="climate-summary" style="display: none;">
    <h3>Klimatpåverkan</h3>
    <div class="climate-summary-items">
      <div class="climate-summary-item">
        <span class="climate-summary-label">A1-A3:</span>
        <span class="climate-summary-value" id="summaryA1A3">0.00 kg CO₂e</span>
      </div>
      <div class="climate-summary-item">
        <span class="climate-summary-label">A4:</span>
        <span class="climate-summary-value" id="summaryA4">0.00 kg CO₂e</span>
      </div>
      <div class="climate-summary-item">
        <span class="climate-summary-label">A5:</span>
        <span class="climate-summary-value" id="summaryA5">0.00 kg CO₂e</span>
      </div>
      <div class="climate-summary-item">
        <span class="climate-summary-label">Totalt:</span>
        <span class="climate-summary-value climate-summary-total" id="summaryTotal">0.00 kg CO₂e</span>
      </div>
      <div class="climate-summary-item" id="summaryReduction" style="display: none;">
        <span class="climate-summary-label">Reduktion:</span>
        <span class="climate-summary-value" style="color: #2e7d32;">0.00 kg CO₂e (0.0%)</span>
      </div>
      <div class="climate-summary-item" id="summaryEpdPercent" style="display: none;">
        <span class="climate-summary-label">EPD-andel:</span>
        <span class="climate-summary-value">0.0%</span>
      </div>
    </div>
  </div>

  <!-- Progress Bar -->
  <div id="progressBar" class="progress-bar" style="display: none;">
    <div class="progress-bar-fill"></div>
    <div class="progress-bar-text">Bearbetar...</div>
  </div>

  <div class="container">
    <h1>INFINITY</h1>
    <div class="picker">
      <input id="fileInput" type="file" accept=".xlsx,.csv,.tsv,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,text/csv,text/tab-separated-values"/>
      <input id="filterInput" class="filter" type="search" placeholder="Filtrera rader..." />
      <label for="groupBy" class="muted">Gruppera efter:</label>
      <select id="groupBy"></select>
      <button id="toggleAllBtn" type="button">Fäll ihop alla</button>
      <button id="addRowBtn" type="button" style="background:#607d8b; color:white;">Lägg till rad</button>
      <button id="exportBtn" type="button" style="background:#607d8b; color:white;">Exportera till Excel</button>
      <button id="undoBtn" type="button" style="background:#607d8b; color:white;" title="Ångra (Ctrl+Z)" disabled>↶ Ångra</button>
      <button id="redoBtn" type="button" style="background:#607d8b; color:white;" title="Gör om (Ctrl+Y)" disabled>↷ Gör om</button>
      <button id="saveProjectBtn" type="button" style="background:#607d8b; color:white;">Spara</button>
      <button id="saveAsProjectBtn" type="button" style="background:#607d8b; color:white;">Spara som...</button>
      <button id="loadProjectBtn" type="button" style="background:#607d8b; color:white;">Öppna projekt</button>
      <button id="testProgressBtn" type="button" style="background:#ff9800; color:white;">Testa Progress Bar</button>
      <button id="logoutBtn" type="button" style="border-radius:9999px; padding:8px 14px; border:1px solid #ef4444; background:#ef4444; color:#fff;">Logga ut</button>
      <input id="projectFileInput" type="file" accept=".json,application/json" style="display:none;" />
    </div>
    <div id="output"></div>
  </div>

  <!-- Layer modal -->
  <div id="layerModal" style="position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index: 2000;">
    <div style="background:#fff; padding:16px; border-radius:8px; width: min(600px, 92vw); box-shadow: 0 10px 30px rgba(0,0,0,.2); max-height: 90vh; overflow-y: auto;">
      <h2 style="margin-top:0;">Dela i skikt</h2>
      <div style="display:flex; gap:12px;">
        <label style="flex:1;">
          Antal skikt
          <input id="layerCount" type="number" min="1" value="2" style="width:100%;" />
        </label>
        <label style="flex:2;">
          Tjocklekar (kommaseparerade i mm)
          <input id="layerThicknesses" type="text" placeholder="t.ex. 10,5" style="width:100%;" />
        </label>
      </div>
      <p class="muted">Lämna tjocklekar tomma för att fördela jämnt.</p>
      
      <!-- Mixed Layer Section -->
      <div style="margin-top:16px; padding:12px; border:1px solid #ddd; border-radius:4px; background:#f9f9f9;">
        <h3 style="margin-top:0; margin-bottom:12px; font-size:1rem;">Blandade skikt</h3>
        <p class="muted" style="margin-top:0; margin-bottom:12px;">Bocka i vilka skikt som är blandningar av två material:</p>
        
        <div id="mixedLayerCheckboxes" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:8px; margin-bottom:16px;">
          <!-- Will be populated dynamically based on layer count -->
        </div>
        
        <div id="mixedLayerDetails" style="display:none; margin-top:12px; padding-top:12px; border-top:1px solid #ddd;">
          <p class="muted" style="margin-top:0; margin-bottom:12px;">Konfigurera de blandade skikten:</p>
          <div id="mixedLayerConfigs">
            <!-- Will be populated dynamically for each mixed layer -->
          </div>
        </div>
      </div>
      
      <!-- Layer Names and Climate Resources Section -->
      <div id="layerNamesSection" style="margin-top:16px; padding:12px; border:1px solid #ddd; border-radius:4px; background:#f9f9f9;">
        <h3 style="margin-top:0; margin-bottom:12px; font-size:1rem;">Skiktnamn och klimatresurser</h3>
        <p class="muted" style="margin-top:0; margin-bottom:12px;">Namnge varje skikt och välj klimatresurs (valfritt):</p>
        
        <div id="layerNamesContainer">
          <!-- Will be populated dynamically based on layer count -->
        </div>
        
      </div>
      
      <div style="display:flex; gap:8px; justify-content:space-between; margin-top:12px;">
        <div style="display:flex; gap:8px;">
          <button id="layerCancel" type="button">Avbryt</button>
          <button id="layerApply" type="button">Dela</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Auth modal -->
  <div id="authModal" style="position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:4000;">
    <div style="background:#fff; padding:24px; border-radius:16px; width:min(420px,95vw); box-shadow:0 10px 30px rgba(0,0,0,.25);">
      <h2 style="margin:0 0 12px 0; font-size:1.2rem;">Logga in</h2>
      <p class="muted" style="margin:0 0 12px 0;">Ange e-post och lösenord för att fortsätta.</p>
      <div style="display:grid; gap:10px;">
        <input id="authEmail" type="email" placeholder="E-post" style="padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px;" />
        <input id="authPassword" type="password" placeholder="Lösenord" style="padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px;" />
        <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:4px;">
          <button id="authRegisterBtn" type="button" style="border-radius:9999px; padding:8px 14px; border:1px solid #e5e7eb;">Registrera</button>
          <button id="authLoginBtn" type="button" style="border-radius:9999px; padding:8px 14px; border:1px solid #1f2937; background:#1f2937; color:#fff;">Logga in</button>
        </div>
        <div id="authError" style="color:#b91c1c; font-size:0.9rem; display:none;"></div>
      </div>
    </div>
  </div>

  <!-- Climate Resource Mapping modal -->
  <div id="climateModal" style="position:fixed; inset:0; background:rgba(0,0,0,.4); display:none; align-items:center; justify-content:center; z-index:3000;">
    <div style="background:#fff; padding:0; border-radius:8px; width: min(900px, 95vw); box-shadow: 0 4px 20px rgba(0,0,0,.15); max-height: 90vh; overflow:hidden; display:flex; flex-direction:column;">

      <!-- Header -->
      <div style="padding:20px 24px; background:#fff; border-bottom:2px solid #e0e0e0;">
        <h2 style="margin:0; font-size:1.3rem; font-weight:600; color:#333;">
          Mappa klimatresurs
        </h2>
      </div>

      <!-- Content -->
      <div style="padding:24px; overflow-y:auto; flex:1; display:flex; gap:20px;">

        <!-- Left Column: Search and List -->
        <div style="flex:1; min-width:350px;">
          <!-- Search Box -->
          <div style="margin-bottom:16px;">
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333; font-size:0.9rem;">
              Sök klimatresurs
            </label>
            <input
              id="climateSearchInput"
              type="text"
              placeholder="Filtrera på namn eller kategori..."
              style="width:100%; padding:10px 12px; border:1px solid #ccc; border-radius:4px; font-size:0.95rem; box-sizing:border-box;"
            />
          </div>

          <!-- Resource List -->
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333; font-size:0.9rem;">
              Tillgängliga resurser
            </label>
            <select
              id="climateResourceSelect"
              size="20"
              style="width:100%; padding:6px; border:1px solid #ccc; border-radius:4px; font-size:0.9rem; background:white;"
            >
              <option value="">Laddar resurser...</option>
            </select>
            <p style="margin:8px 0 0 0; color:#666; font-size:0.85rem;">
              Resurser grupperade efter kategori
            </p>
          </div>
        </div>

        <!-- Right Column: Resource Details -->
        <div style="flex:1; min-width:350px; background:#f9f9f9; padding:20px; border-radius:4px; border:1px solid #e0e0e0;">
          <h3 style="margin:0 0 16px 0; font-size:1rem; font-weight:600; color:#333;">Resursdetaljer</h3>
          <div id="climateResourceDetails" style="font-size:0.9rem; color:#555; line-height:1.6;">
            <p style="color:#999; font-style:italic;">Välj en resurs för att se detaljer</p>
          </div>

          <div style="margin-top:20px; padding:12px; background:white; border-radius:4px; border:1px solid #ddd;">
            <p style="margin:0; color:#666; font-size:0.85rem; line-height:1.5;">
              <strong>Info:</strong> Fyra nya kolumner läggs till när du mappar en resurs: Klimatresurs, Omräkningsfaktor, Omräkningsfaktor enhet och Avfallsfaktor.
            </p>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div style="padding:16px 24px; background:#f5f5f5; border-top:1px solid #e0e0e0; display:flex; gap:12px; justify-content:flex-end;">
        <button id="climateCancel" type="button" style="padding:8px 20px; border:1px solid #999; background:white; border-radius:4px; font-size:0.95rem; cursor:pointer;">
          Avbryt
        </button>
        <button id="climateApply" type="button" style="padding:8px 20px; border:1px solid #555; background:#555; color:white; border-radius:4px; font-size:0.95rem; cursor:pointer;">
          Mappa resurs
        </button>
      </div>
    </div>
  </div>

  <!-- Alternative Climate Resource modal -->
  <div id="altClimateModal" style="position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:2500;">
    <div style="background:#fff; padding:20px; border-radius:8px; width: min(700px, 95vw); max-height: 85vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,.2);">
      <h2 style="margin-top:0; color:#2196f3;">Alternativ klimatresurs</h2>
      
      <!-- EPD Selection Method -->
      <div style="margin-bottom:20px; padding:16px; background:#f8f9fa; border-radius:8px; border:1px solid #e9ecef;">
        <h3 style="margin-top:0; margin-bottom:12px; color:#333; font-size:16px;">Välj datakälla</h3>
        <div style="display:flex; gap:12px; margin-bottom:16px;">
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
            <input type="radio" name="epdSource" value="manual" checked style="margin:0;">
            <span>Manuell inmatning</span>
          </label>
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
            <input type="radio" name="epdSource" value="epd" style="margin:0;">
            <span>Välj från EPD-fil</span>
          </label>
        </div>
        
        <!-- EPD File Selection -->
        <div id="epdFileSection" style="display:none;">
          <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">
            Välj EPD-fil
          </label>
          <select id="epdFileSelect" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:4px; font-size:14px;">
            <option value="">Laddar EPD-filer...</option>
          </select>
          <small style="color:#666; font-size:12px; margin-top:4px; display:block;">
            EPD-filer läses från mappen "epd" i programmets rotmapp
          </small>
        </div>
        
        <!-- EPD Preview -->
        <div id="epdPreview" style="display:none; margin-top:16px; padding:12px; background:#e8f5e8; border-radius:6px; border:1px solid #c3e6c3;">
          <h4 style="margin:0 0 8px 0; color:#2e7d32; font-size:14px;">📋 EPD-förhandsvisning</h4>
          <div id="epdPreviewContent" style="font-size:13px; color:#333;">
            <!-- Will be populated with EPD data -->
          </div>
        </div>
      </div>
      
      <p class="muted" style="margin-bottom:16px;">Mata in EPD-data manuellt för denna resurs.</p>
      
      <div style="display:grid; gap:16px; margin-bottom:20px;">
        <!-- EPD Name -->
        <div>
          <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">
            EPD-namn *
          </label>
          <input id="altClimateName" type="text" placeholder="t.ex. Betong C25/30" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:4px; font-size:14px;" />
        </div>

        <!-- Declared Unit -->
        <div>
          <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">
            Deklarerad enhet *
          </label>
          <select id="altClimateUnit" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:4px; font-size:14px;">
            <option value="">Välj enhet...</option>
            <option value="kg">kg (kilogram)</option>
            <option value="m2">m² (kvadratmeter)</option>
            <option value="m3">m³ (kubikmeter)</option>
            <option value="st">st (styck)</option>
            <option value="m">m (meter)</option>
            <option value="l">l (liter)</option>
            <option value="t">t (ton)</option>
          </select>
        </div>

        <!-- Conversion Factor -->
        <div>
          <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">
            Omräkningsfaktor *
          </label>
          <input id="altClimateFactor" type="number" step="0.001" placeholder="t.ex. 1.0" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:4px; font-size:14px;" />
        </div>

        <!-- Conversion Factor Unit -->
        <div>
          <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">
            Omräkningsfaktor enhet *
          </label>
          <select id="altClimateFactorUnit" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:4px; font-size:14px;">
            <option value="">Välj enhet...</option>
            <option value="kg/m³">kg/m³ (volym)</option>
            <option value="kg/m²">kg/m² (area)</option>
            <option value="kg/m">kg/m (längd)</option>
            <option value="kg/st">kg/st (styck)</option>
          </select>
        </div>

        <!-- Waste Factor -->
        <div>
          <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">
            Spillfaktor (decimaltal)
          </label>
          <input id="altClimateWaste" type="number" step="0.01" placeholder="t.ex. 0.05" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:4px; font-size:14px;" />
          <small style="color:#666; font-size:12px; margin-top:4px; display:block;">
            Används för att beräkna inköpt vikt. 0.05 = 5% spill
          </small>
        </div>

        <!-- Climate Impact A1-A3 -->
        <div>
          <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">
            Klimatpåverkan A1-A3 (kg CO₂e/deklarerad enhet) *
          </label>
          <input id="altClimateA1A3" type="number" step="0.001" placeholder="t.ex. 0.245" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:4px; font-size:14px;" />
        </div>

        <!-- Climate Impact A4 -->
        <div>
          <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">
            Klimatpåverkan A4 (kg CO₂e/deklarerad enhet)
          </label>
          <input id="altClimateA4" type="number" step="0.001" placeholder="t.ex. 0.012" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:4px; font-size:14px;" />
        </div>

        <!-- Climate Impact A5 -->
        <div>
          <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">
            Klimatpåverkan A5 (kg CO₂e/deklarerad enhet)
          </label>
          <input id="altClimateA5" type="number" step="0.001" placeholder="t.ex. 0.008" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:4px; font-size:14px;" />
        </div>
      </div>

      <div style="display:flex; gap:12px; justify-content:flex-end; margin-top:20px; padding-top:16px; border-top:2px solid #ddd;">
        <button id="altClimateCancel" type="button" style="padding:10px 20px; background:#f5f5f5; border:1px solid #ddd; border-radius:4px;">Avbryt</button>
        <button id="altClimateApply" type="button" style="background:#2196f3; color:white; border:1px solid #1976d2; padding:10px 24px; font-weight:600; border-radius:4px;">Lägg till resurs</button>
      </div>
    </div>
  </div>

  <!-- Multi-layer Climate Resource Mapping modal -->
  <div id="multiLayerClimateModal" style="position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:2400;">
    <div style="background:#fff; padding:20px; border-radius:8px; width: min(900px, 95vw); max-height: 85vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,.2);">
      <h2 style="margin-top:0;">Mappa klimatresurser till skikt</h2>
      
      <p class="muted" style="margin-bottom:16px;">Sök och välj klimatresurs för varje skikt. Du kan skriva för att filtrera listan.</p>
      
      <div id="multiLayerClimateContent" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap:16px; margin-bottom:16px;">
        <!-- Will be populated dynamically -->
      </div>

      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:16px; padding-top:16px; border-top:2px solid #ddd;">
        <button id="multiLayerClimateCancel" type="button" style="padding:10px 20px;">Avbryt</button>
        <button id="multiLayerClimateApply" type="button" style="background:#4caf50; color:white; border:1px solid #45a049; padding:10px 24px; font-weight:600;">Applicera alla</button>
      </div>
    </div>
  </div>

  <!-- Manual Conversion Factor modal -->
  <div id="manualFactorModal" style="position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index: 2600;">
    <div style="background:#fff; padding:20px; border-radius:8px; width: min(500px, 92vw); box-shadow: 0 10px 30px rgba(0,0,0,.2);">
      <h2 style="margin-top:0; color: #ff9800;">⚠️ Saknad omräkningsfaktor</h2>
      
      <p style="margin-bottom:16px;">
        Den valda klimatresursen <strong id="manualFactorResourceName"></strong> saknar omräkningsfaktor i API:n.
        Vänligen ange en egen omräkningsfaktor:
      </p>

      <div style="display:flex; flex-direction:column; gap:12px; margin-bottom:16px;">
        <label style="display:flex; flex-direction:column; gap:4px;">
          <span style="font-weight:600;">Omräkningsfaktor:</span>
          <input id="manualFactorValue" type="number" step="0.001" placeholder="t.ex. 2400" style="padding:8px; border:1px solid #ddd; border-radius:4px;" />
        </label>

        <label style="display:flex; flex-direction:column; gap:4px;">
          <span style="font-weight:600;">Enhet:</span>
          <select id="manualFactorUnit" style="padding:8px; border:1px solid #ddd; border-radius:4px;">
            <option value="kg/m³">kg/m³ (volym)</option>
            <option value="kg/m²">kg/m² (area)</option>
            <option value="kg/m">kg/m (längd)</option>
            <option value="kg/st">kg/st (styck)</option>
          </select>
        </label>
      </div>

      <div style="display:flex; gap:8px; justify-content:flex-end;">
        <button id="manualFactorCancel" type="button">Avbryt</button>
        <button id="manualFactorApply" type="button" style="background:#4caf50; color:white; border:1px solid #45a049;">Använd</button>
      </div>
    </div>
  </div>

  <!-- SheetJS library for Excel export -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  
  <!-- EPD Parser -->
  <script src="epd-parser.js"></script>

  <script type="module" src="app.js"></script>

  <script>
    // Simple production gate: require login if not on localhost
    const IS_PROD = location.hostname !== 'localhost' && location.hostname !== '127.0.0.1';
    function getToken(){ try { return localStorage.getItem('auth_token') || ''; } catch(_) { return ''; } }
    function setToken(t){ try { t ? localStorage.setItem('auth_token', t) : localStorage.removeItem('auth_token'); } catch(_){} }
    async function authFetch(url, opts = {}){
      const token = getToken();
      const headers = Object.assign({}, opts.headers || {}, token ? { Authorization: 'Bearer ' + token } : {});
      const res = await fetch(url, Object.assign({}, opts, { headers }));
      if(res.status === 401 && IS_PROD){ showAuthModal(); throw new Error('Unauthorized'); }
      return res;
    }
    const apiIndicator = document.getElementById('apiIndicator');
    const epdIndicator = document.getElementById('epdIndicator');
    const climateResourceSelect = document.getElementById('climateResourceSelect');
    const logoutBtn = document.getElementById('logoutBtn');
    const climateSearchInput = document.getElementById('climateSearchInput');

    // Store climate resources globally so they can be accessed when numbering
    window.climateResources = [];

    // Function to populate climate resources with categories
    function populateClimateResourcesWithCategories(resources) {
      // Group resources by category
      const categorizedResources = {};

      resources.forEach((resource, index) => {
        const category = resource.Categories && resource.Categories.length > 0
          ? resource.Categories[0].Text
          : 'Övrigt';

        if (!categorizedResources[category]) {
          categorizedResources[category] = [];
        }

        categorizedResources[category].push({
          index: index,
          name: resource.Name || 'Namnlös resurs',
          resource: resource
        });
      });

      // Sort categories alphabetically
      const sortedCategories = Object.keys(categorizedResources).sort();

      // Populate select with optgroups
      climateResourceSelect.innerHTML = '<option value="">Välj en resurs...</option>';

      sortedCategories.forEach(category => {
        const optgroup = document.createElement('optgroup');
        optgroup.label = category;

        // Sort resources within category
        categorizedResources[category]
          .sort((a, b) => a.name.localeCompare(b.name, 'sv'))
          .forEach(item => {
            const option = document.createElement('option');
            option.value = item.index;
            option.textContent = item.name;
            option.dataset.category = category;
            option.dataset.searchText = `${category} ${item.name}`.toLowerCase();
            optgroup.appendChild(option);
          });

        climateResourceSelect.appendChild(optgroup);
      });
    }

    // Search function for climate resources
    if (climateSearchInput) {
      climateSearchInput.addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase().trim();
        const options = climateResourceSelect.querySelectorAll('option');
        const optgroups = climateResourceSelect.querySelectorAll('optgroup');

        if (!searchTerm) {
          // Show all
          options.forEach(opt => opt.style.display = '');
          optgroups.forEach(grp => grp.style.display = '');
          return;
        }

        // Hide all optgroups initially
        optgroups.forEach(grp => grp.style.display = 'none');

        // Filter options
        options.forEach(opt => {
          if (opt.value === '') {
            opt.style.display = '';
            return;
          }

          const searchText = opt.dataset.searchText || opt.textContent.toLowerCase();
          if (searchText.includes(searchTerm)) {
            opt.style.display = '';
            // Show parent optgroup
            const parentOptgroup = opt.parentElement;
            if (parentOptgroup && parentOptgroup.tagName === 'OPTGROUP') {
              parentOptgroup.style.display = '';
            }
          } else {
            opt.style.display = 'none';
          }
        });
      });
    }

    // Show resource details when selected
    if (climateResourceSelect) {
      climateResourceSelect.addEventListener('change', function(e) {
        const detailsDiv = document.getElementById('climateResourceDetails');
        if (!detailsDiv) return;

        const selectedIndex = parseInt(e.target.value);
        if (isNaN(selectedIndex) || !window.climateResources || !window.climateResources[selectedIndex]) {
          detailsDiv.innerHTML = '<p style="color:#999; font-style:italic;">Välj en resurs för att se detaljer</p>';
          return;
        }

        const resource = window.climateResources[selectedIndex];
        console.log('Selected resource for details:', resource);

        const category = resource.Categories && resource.Categories.length > 0 ? resource.Categories[0].Text : 'Ej kategoriserad';

        // Extract conversion factor and unit - same logic as applyClimateResource in app.js
        let conversionFactor = (resource.Conversions && resource.Conversions[0] && resource.Conversions[0].Value) ||
                                resource.ConservativeDataConversionFactor ||
                                resource.ConversionFactor ||
                                resource.Factor ||
                                resource.Omräkningsfaktor ||
                                null;
        let conversionUnit = (resource.Conversions && resource.Conversions[0] && resource.Conversions[0].Unit) || null;
        let wasteFactor = resource.WasteFactor || null;

        let conversionFactorDisplay = '<span style="color:#999;">Ej angiven</span>';
        if (conversionFactor !== null && conversionFactor !== undefined) {
          conversionFactorDisplay = `${conversionFactor}${conversionUnit ? ' ' + conversionUnit : ''}`;
        }

        let wasteFactorDisplay = '<span style="color:#999;">Ej angiven</span>';
        if (wasteFactor !== null && wasteFactor !== undefined) {
          wasteFactorDisplay = wasteFactor;
        }

        let detailsHTML = `
          <div style="margin-bottom:12px;">
            <strong style="color:#333;">Namn:</strong>
            <div style="margin-top:4px; padding:8px; background:white; border-radius:4px; border:1px solid #ddd;">${resource.Name || 'Okänt'}</div>
          </div>

          <div style="margin-bottom:12px;">
            <strong style="color:#333;">Kategori:</strong>
            <div style="margin-top:4px; padding:8px; background:white; border-radius:4px; border:1px solid #ddd;">${category}</div>
          </div>

          <div style="margin-bottom:12px;">
            <strong style="color:#333;">Omräkningsfaktor:</strong>
            <div style="margin-top:4px; padding:8px; background:white; border-radius:4px; border:1px solid #ddd;">
              ${conversionFactorDisplay}
            </div>
          </div>

          <div style="margin-bottom:12px;">
            <strong style="color:#333;">Avfallsfaktor:</strong>
            <div style="margin-top:4px; padding:8px; background:white; border-radius:4px; border:1px solid #ddd;">
              ${wasteFactorDisplay}
            </div>
          </div>
        `;

        if (resource.Description) {
          detailsHTML += `
            <div style="margin-bottom:12px;">
              <strong style="color:#333;">Beskrivning:</strong>
              <div style="margin-top:4px; padding:8px; background:white; border-radius:4px; border:1px solid #ddd; font-size:0.85rem;">${resource.Description}</div>
            </div>
          `;
        }

        // Show additional conversion factors if available (same field check as app.js)
        if (resource.Conversions && Array.isArray(resource.Conversions) && resource.Conversions.length > 1) {
          detailsHTML += `
            <div style="margin-bottom:12px;">
              <strong style="color:#333;">Ytterligare omräkningsfaktorer:</strong>
              <div style="margin-top:4px; padding:8px; background:white; border-radius:4px; border:1px solid #ddd; font-size:0.85rem;">
          `;
          resource.Conversions.forEach((conv, idx) => {
            if (idx > 0) {
              detailsHTML += `<div style="margin-top:4px;">${conv.Type || 'Typ ' + (idx+1)}: ${conv.Value}${conv.Unit ? ' ' + conv.Unit : ''}</div>`;
            }
          });
          detailsHTML += `</div></div>`;
        }

        detailsDiv.innerHTML = detailsHTML;
      });

      // Add double-click to quickly apply selected resource
      climateResourceSelect.addEventListener('dblclick', function(e) {
        const selectedIndex = parseInt(this.value);
        if (isNaN(selectedIndex) || selectedIndex < 0) {
          return;
        }

        // Trigger the apply button click
        const applyBtn = document.getElementById('climateApply');
        if (applyBtn) {
          applyBtn.click();
        }
      });
    }

    fetch('https://api.boverket.se/klimatdatabas/v2/get-all-resources/senaste/sv/json')
      .then(res =>{
        return res.json();
      })
      .then(data =>{
        console.log('API Response:', data); // Debug log
        
        // Update API indicator with success status
        if(data && data.Resources && Array.isArray(data.Resources)){
          const version = data.Version || 'Okänd version';
          const publishedDate = data.PublishedDate ? new Date(data.PublishedDate).toLocaleDateString('sv-SE') : 'Okänt datum';
          
          apiIndicator.className = 'api-indicator connected';
          apiIndicator.innerHTML = `
            <div class="api-status">
              <span class="api-status-dot connected"></span>
              <span>Boverket API</span>
            </div>
            <div class="api-details">
              Version: ${version}<br>
              Publicerad: ${publishedDate}
            </div>
          `;
          
          // Store resources and populate dropdown with categories
          window.climateResources = data.Resources;
          populateClimateResourcesWithCategories(data.Resources);
        } else if(Array.isArray(data)){
          // Fallback: if data is directly an array
          apiIndicator.className = 'api-indicator connected';
          apiIndicator.innerHTML = `
            <div class="api-status">
              <span class="api-status-dot connected"></span>
              <span>Boverket API</span>
            </div>
          `;
          
          window.climateResources = data;
          populateClimateResourcesWithCategories(data);
        } else {
          apiIndicator.className = 'api-indicator error';
          apiIndicator.innerHTML = `
            <div class="api-status">
              <span class="api-status-dot error"></span>
              <span>API-fel</span>
            </div>
            <div class="api-details">Oväntat format</div>
          `;
          climateResourceSelect.innerHTML = '<option value="">Inga resurser tillgängliga</option>';
        }
      })
      .catch(err =>{
        console.error('API Error:', err);
        
        // Update API indicator with error status
        apiIndicator.className = 'api-indicator error';
        apiIndicator.innerHTML = `
          <div class="api-status">
            <span class="api-status-dot error"></span>
            <span>Anslutning misslyckades</span>
          </div>
          <div class="api-details">${err.message || 'Okänt fel'}</div>
        `;
        climateResourceSelect.innerHTML = '<option value="">Kunde inte ladda resurser</option>';
      });
    
    // EPD files will be loaded by app.js after it initializes

    // Auth helpers
    function showAuthModal(){ const el = document.getElementById('authModal'); if(el) el.style.display = 'flex'; }
    function hideAuthModal(){ const el = document.getElementById('authModal'); if(el) el.style.display = 'none'; }
    async function performLogin(email, password){
      const res = await fetch('/api/login', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ email, password }) });
      const data = await res.json();
      if(!res.ok){ throw new Error(data.error || 'Login failed'); }
      setToken(data.token); hideAuthModal();
    }
    async function performRegister(email, password){
      const res = await fetch('/api/register', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ email, password }) });
      const data = await res.json();
      if(!res.ok){ throw new Error(data.error || 'Register failed'); }
      setToken(data.token); hideAuthModal();
    }
    function setupAuthUI(){
      const loginBtn = document.getElementById('authLoginBtn');
      const registerBtn = document.getElementById('authRegisterBtn');
      const emailEl = document.getElementById('authEmail');
      const passEl = document.getElementById('authPassword');
      const errEl = document.getElementById('authError');
      if(loginBtn){
        loginBtn.addEventListener('click', async () => {
          errEl.style.display = 'none';
          try { await performLogin(emailEl.value.trim(), passEl.value); } catch(e){ errEl.textContent = e.message; errEl.style.display = 'block'; }
        });
      }
      if(registerBtn){
        registerBtn.addEventListener('click', async () => {
          errEl.style.display = 'none';
          try { await performRegister(emailEl.value.trim(), passEl.value); } catch(e){ errEl.textContent = e.message; errEl.style.display = 'block'; }
        });
      }
    }

    // Gate UI in production
    setupAuthUI();
    if(IS_PROD && !getToken()){
      showAuthModal();
    }
    if(logoutBtn){ logoutBtn.addEventListener('click', () => { setToken(''); if(IS_PROD) showAuthModal(); }); }
  </script>
</body>
</html>